<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>M - Solução do Problema</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap"
    rel="stylesheet"
  />
  <!-- Ícones Material (para manter o mesmo design do header de resultados.html) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    /* Reset básico */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* BODY apenas com cor de fundo, sem imagem.
       A imagem agora ficará em um elemento DIV fixo (.fixed-bg) para
       evitar o problema em dispositivos móveis (principalmente iOS).
    */
    body {
      font-family: 'Roboto', sans-serif;
      font-size: 1rem;
      background-color: #f0f0f0;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Elemento fixo que segura a imagem de fundo (compatível com mobile/iOS) */
    .fixed-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-repeat: no-repeat;
      background-position: center center;
      background-size: cover;
      z-index: -1;
    }

    /* =================================================================
       HEADER FIXO - mesmo design de resultados.html
       ================================================================= */
    header {
      background-color: #000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
      height: 80px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    @media (max-width: 768px) {
      header {
        height: 56px;
        padding: 0 1rem;
      }
    }
    header h1 {
      color: #fff;
      font-size: 1.6rem;
      margin: 0;
      text-align: center;
      flex: 1;
    }
    /* Botão de voltar com o mesmo estilo do menu */
    .header-btn {
      background: none;
      border: none;
      cursor: pointer;
      outline: none;
      color: #fff;
      display: flex;
      align-items: center;
      text-decoration: none;
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }
    .header-btn:hover {
      background-color: #333;
    }
    .header-btn svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }

    /* =================================================================
       MAIN
       ================================================================= */
    main {
      flex: 1;
      font-size: 1.25rem;
      padding: 2rem;
      width: 100%;
      max-width: 1200px;
      margin: 100px auto 0; /* Espaço para não ficar atrás do header fixo */
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Informações do criador e solucionador */
    .creator-info,
    .solver-info {
      font-size: 1.1rem;
      font-weight: 500;
      color: #555;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    /* Container do problema */
    .problem-container {
      width: 100%;
      margin-top: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 2rem;
      background-color: #fff;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h2 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      color: #000;
      font-weight: 700;
      text-align: center;
    }
    p.description {
      margin-bottom: 2rem;
      color: #555;
      font-size: 1.2rem;
      max-width: 1000px;
      text-align: center;
      margin-left: auto;
      margin-right: auto;
    }

    .problem-image {
      display: block;
      margin: 1rem auto;
      width: auto;
      height: auto;
      max-width: 400px;
      max-height: 300px;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .section-divider {
      border: none;
      border-top: 1px solid #ccc;
      margin: 2rem 0;
      width: 100%;
      max-width: 1100px;
    }

    /* Botões */
    .show-solution-btn {
      background-color: #000;
      color: #fff;
      border: none;
      border-radius: 32px;
      padding: 0.8rem 1.4rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.2s;
      margin: 1rem 0;
      display: inline-block;
      text-decoration: none;
    }
    .show-solution-btn:hover {
      background-color: #333;
      transform: scale(1.02);
    }

    /* Botão share WhatsApp */
    .whatsapp-share-btn {
      background-color: #000;
      color: #fff;
      border: none;
      border-radius: 32px;
      padding: 0.8rem 1.4rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.2s;
      margin: 1rem 0.5rem;
      display: inline-flex;
      align-items: center;
      text-decoration: none;
      gap: 0.5rem;
    }
    .whatsapp-share-btn:hover {
      background-color: #333;
      transform: scale(1.02);
    }
    .whatsapp-icon {
      fill: currentColor;
      width: 20px;
      height: 20px;
    }

    /* Container da solução */
    .solution-container {
      width: 100%;
      margin-top: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 2rem;
      background-color: #fff;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .solution-container h3 {
      margin-bottom: 1rem;
      font-size: 1.6rem;
      color: #000;
      font-weight: 700;
      text-align: center;
    }

    /* Barra de progresso dos passos */
    .progress-container {
      position: relative;
      width: 100%;
      max-width: 600px;
      height: 20px;
      background-color: #eee;
      border-radius: 10px;
      margin: 1rem auto 0;
    }
    .progress-bar {
      height: 100%;
      background-color: #00b300;
      width: 0%;
      border-radius: 10px;
      transition: width 0.4s ease;
    }
    .progress-info {
      text-align: center;
      font-size: 1rem;
      color: #555;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
    }

    /* Área de saída dos passos */
    .steps-output {
      margin-top: 2rem;
      line-height: 1.7;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 1.05rem;
      margin-bottom: 2.5rem;
      min-height: 80px;
      color: #333;
      max-width: 1100px;
      margin-left: auto;
      margin-right: auto;
    }
    .step-container {
      margin-bottom: 2rem;
      padding: 1rem 1rem 2rem;
      border-left: 4px solid #000;
      background-color: #fafafa;
      transition: background-color 0.2s ease-in-out;
      max-width: 1100px;
      margin-left: auto;
      margin-right: auto;
      position: relative;
    }
    .step-title-block {
      font-size: 1.4rem;
      color: #000;
      margin-bottom: 0.8rem;
      font-weight: bold;
    }
    .step-description-block {
      font-size: 1.2rem;
      color: #444;
      margin-bottom: 1rem;
      white-space: pre-wrap;
      line-height: 1.6;
    }
    .step-image-block {
      text-align: center;
      margin-bottom: 1rem;
    }
    .step-image-block img {
      max-width: 400px;
      width: 100%;
      height: auto;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 0.5rem;
    }
    .step-check-icon {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      font-size: 2rem;
      color: #0a0;
      opacity: 0.8;
    }

    /* Subpassos */
    .mini-steps-block {
      margin-left: 1rem;
      margin-top: 1rem;
      border-left: 3px dashed #333;
      padding-left: 1rem;
    }
    .mini-step-container {
      margin-bottom: 1.5rem;
      display: none;
    }
    .mini-step-title {
      font-size: 1.2rem;
      color: #333;
      font-weight: bold;
      margin-bottom: 0.3rem;
      display: block;
    }
    .mini-step-description {
      font-size: 1.05rem;
      color: #555;
      white-space: pre-wrap;
      margin-bottom: 0.5rem;
      display: block;
      line-height: 1.5;
    }
    .mini-step-image-block {
      text-align: center;
      margin-bottom: 1rem;
    }
    .mini-step-image-block img {
      max-width: 350px;
      width: 100%;
      height: auto;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 0.5rem;
    }
    .mini-steps-btn {
      background-color: #000;
      color: #fff;
      border: none;
      border-radius: 32px;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.2s;
      margin: 0.5rem 0;
      display: inline-block;
      text-decoration: none;
    }
    .mini-steps-btn:hover {
      background-color: #333;
      transform: scale(1.02);
    }

    /* Botões de feedback (Conseguiu / Não Conseguiu) */
    .feedback-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1rem;
    }
    #btnConsegui,
    #btnNaoConsegui {
      background-color: #fff;
      color: #000;
      border: 1px solid #000;
      border-radius: 28px;
      padding: 0.7rem 1.2rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s;
      display: inline-block;
      text-decoration: none;
    }
    #btnConsegui:hover,
    #btnNaoConsegui:hover {
      transform: scale(1.02);
    }

    .shake {
      animation: shake 0.5s;
    }
    @keyframes shake {
      0% { transform: translate(0, 0); }
      20% { transform: translate(-5px, 0); }
      40% { transform: translate(5px, 0); }
      60% { transform: translate(-5px, 0); }
      80% { transform: translate(5px, 0); }
      100% { transform: translate(0, 0); }
    }

    /* Form de feedback de falha */
    .fail-feedback-form {
      text-align: center;
      margin-top: 1rem;
      display: none;
    }
    .fail-feedback-form textarea {
      width: 100%;
      max-width: 600px;
      height: 80px;
      margin-bottom: 0.5rem;
      font-size: 1rem;
      padding: 0.5rem;
    }
    .fail-feedback-form button {
      background-color: #444;
      color: #fff;
      border: none;
      border-radius: 24px;
      padding: 0.6rem 1rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .fail-feedback-form button:hover {
      background-color: #666;
    }
    .fail-feedback-thank {
      font-size: 0.95rem;
      color: #666;
      margin-top: 0.5rem;
    }

    /* Bloco "Essa solução te ajudou?" */
    .helpful-question p {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: #333;
      font-weight: 500;
    }
    .helpful-feedback-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }
    .helpful-question .helpful-btn {
      background-color: #fff;
      color: #000;
      border: 1px solid #000;
      border-radius: 28px;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s;
      margin: 0 0.5rem;
    }
    .helpful-question .helpful-btn:hover {
      transform: scale(1.02);
    }
    .helpful-btn.selected {
      background-color: #000;
      color: #fff;
    }

    /* Container de feedback da solução */
    .feedback-container {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      background-color: #fff;
      text-align: center;
      max-width: 600px;
      width: 100%;
    }

    /* Rodapé */
    footer {
      background-color: #000;
      text-align: center;
      padding: 1rem 2rem;
      margin-top: auto;
    }
    footer p {
      font-size: 0.9rem;
      color: #fff;
      margin: 0;
    }

    /* Modal de sugestão */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: #f7f7f7;
      width: 95%;
      max-width: 700px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      animation: modalFadeIn 0.3s ease;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
      overflow: hidden;
      border: 1px solid #fff;
    }
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .modal-header {
      background-color: #000;
      color: #fff;
      padding: 2rem;
      position: relative;
      border-bottom: 1px solid #333;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 2rem;
      font-weight: 500;
    }
    .close {
      color: #fff;
      position: absolute;
      right: 2rem;
      top: 2rem;
      font-size: 2.4rem;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
    }
    .close:hover {
      color: #ccc;
    }
    .modal-body {
      padding: 2rem;
      text-align: center;
      overflow-y: auto;
      max-height: calc(90vh - 100px);
    }

    /* =========================
       Ajustes para Dispositivos Móveis
       ========================= */
    @media (max-width: 768px) {
      /* Ajustes para containers ficarem mais próximos das laterais */
      main {
        padding: 0.5rem;
        margin: 56px auto 0; /* Ajusta para não ficar atrás do header menor */
      }
      .problem-container,
      .solution-container,
      .feedback-container {
        width: 98%;
        margin: 0.5rem auto;
        padding: 1rem;
      }
      .step-container,
      .mini-step-container {
        margin: 0.5rem auto;
        padding: 0.5rem;
      }
      .modal-content {
        width: 98%;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Div fixa de fundo, para manter a imagem parada em dispositivos mobile -->
  <div
    class="fixed-bg"
    style="background-image: url('{{ url_for("static", filename="images/" ~ random_bg) }}');"
  ></div>

  <!-- Barra superior fixa (mesmo design de resultados.html) -->
  <header>
    <!-- Botão "Voltar" redirecionando para 'search', como no solucao.html original -->
    <button class="header-btn" onclick="window.location.href='{{ url_for('search') }}'" aria-label="Voltar">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <h1>Detalhes e Solução</h1>
    <div style="width: 40px;"></div>
  </header>

  <main>
    <!-- Container do problema -->
    <div class="problem-container">
      <p class="creator-info">Enviado por: {{ creator_name }}</p>
      <h2>{{ problema["titulo"] }}</h2>
      <p class="description">{{ problema["descricao"] }}</p>

      {% if problema.problemImageThumb %}
        <img
          src="{{ url_for('gridfs_image_thumb', file_id=problema.problemImageThumb) }}"
          alt="Thumbnail do Problema"
          class="problem-image"
        />
      {% elif problema.problemImage %}
        <img
          src="{{ url_for('gridfs_image', file_id=problema.problemImage) }}"
          alt="Imagem do Problema"
          class="problem-image"
        />
      {% endif %}

      <div style="text-align: center; margin-top: 1rem;">
        <a
          href="https://wa.me/?text={{ share_msg_encoded }}"
          class="whatsapp-share-btn"
          target="_blank"
          rel="noopener noreferrer"
        >
          <svg class="whatsapp-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
            <path d="M380.9 97.1C339 55.2 283.2 32 224 32 100.3 32 0 132.3 0 256c0 45.4 11.8 89.3 34.3 128L0 480l100.6 -33.2c37.9 20.8 81 31.8 123.4 31.8h.1c124 0 224.4-100.3 224.6-224.3.1-59.3-23-115.2 -67.8-159.2zM224.1 400c-35 0-69.2 -9.3-98.6-26.9l-6.9-4.1-58.4 19.3 19.6-57.1-4.5-7c-17.6-28 -26.8-60.4-26.8-93.8 0-97.5 79.2-176.8 176.8-176.8 47.2 0 91.6 18.4 124.9 51.7 33.2 33.2 51.5 77.6 51.4 124.7-.2 97.5-79.4 176.7 -176.8 176.7zm101.7-131.5c-5.6-2.8-33.2-16.4 -38.4-18.2-5.1-1.9-8.8 -2.8-12.6 2.8-3.7 5.6-14.4 18.2-17.6 21.9-3.2 3.7 -6.5 4.2-12.1 1.4-5.6 -2.8-23.6-8.7-45-27.6 -16.6-14.7-27.8-32.8 -31-38.4-3.2-5.6-.3-8.6 2.4-11.3 2.5-2.5 5.6-6.5 8.4-9.7s3.7-5.6 5.6-9.3c1.9-3.7.9-7-0.5 -9.8-1.4-2.8-12.6-30.4 -17.3-41.8-4.5-11-9.1-9.3-12.6-9.5-3.2-.2-7-.2-10.7-.2s-9.8 1.4 -15 6.9c-5.1 5.6-19.7 19.3-19.7 47.1s20.2 54.5 23 58.2c2.8 3.7 39.8 60.7 96.4 85.2 13.4 5.8 23.8 9.3 31.9 11.9 13.4 4.2 25.6 3.6 35.2 2.2 10.7-1.6 33.2-13.5 37.9-26.6 4.7-13.2 4.7-24.5 3.2-26.6 -1.6-2.1-5.1-3.4 -10.7-6.2z"/>
          </svg>
          Enviar
        </a>
      </div>
    </div>

    <hr class="section-divider" />

    <!-- Container da solução -->
    <div
      class="solution-container"
      id="solutionContainer"
      data-steps='{{ solucao.get("steps", [])|tojson }}'
      data-problem-id="{{ problema['_id'] }}"
    >
      <p class="solver-info">Resolvido por: {{ solver_name }}</p>
      <h3>Solução:</h3>

      <button
        type="button"
        class="show-solution-btn"
        id="btnShowSolution"
        style="display: none;"
      >
        Mostrar Passos
      </button>

      <div class="steps-output"></div>

      <div class="feedback-buttons" id="feedbackButtons" style="display: none;">
        <button type="button" class="feedback-btn" id="btnConsegui">
          ✅ Consegui!
        </button>
        <button type="button" class="feedback-btn" id="btnNaoConsegui">
          ❌ Não Consegui
        </button>
      </div>

      <div class="fail-feedback-form" id="failFeedbackForm">
        <textarea
          id="failFeedbackText"
          placeholder="Descreva o que houve dificuldade..."
        ></textarea>
        <br />
        <button type="button" id="btnEnviarFeedback">Enviar Feedback</button>
        <div class="fail-feedback-thank">
          Seu feedback nos ajuda a melhorar a plataforma! 😊
        </div>
      </div>

      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="progress-info" id="progressInfo">0 de 0 Passos</div>
    </div>

    <!-- Container para feedback da solução -->
    <div class="feedback-container">
      <div class="helpful-question">
        <p>Essa solução te ajudou?</p>
        <div class="helpful-feedback-buttons">
          <button
            type="button"
            class="helpful-btn {% if user_helpful_feedback == 'SIM' %}selected{% endif %}"
            id="btnHelpfulSim"
          >
            👍 Sim
          </button>
          <button
            type="button"
            class="helpful-btn {% if user_helpful_feedback == 'NAO' %}selected{% endif %}"
            id="btnHelpfulNao"
          >
            👎 Não
          </button>
        </div>
        <button
          type="button"
          class="helpful-btn"
          id="btnOpenSuggestionModal"
          style="margin-top: 1rem;"
        >
          💡 Sugerir melhorias
        </button>
      </div>
    </div>

    <!-- Modal de sugestão de melhorias -->
    <div id="suggestionModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Sugerir Melhorias</h2>
          <span class="close" id="btnCloseSuggestionModal">&times;</span>
        </div>
        <div class="modal-body">
          <form
            action="{{ url_for('suggest_improvement', problem_id=problema['_id']) }}"
            method="POST"
          >
            <textarea
              name="suggestion"
              rows="5"
              placeholder="Descreva sua sugestão..."
              style="width: 100%; max-width:600px;"
            ></textarea>
            <br />
            <button
              type="submit"
              class="show-solution-btn"
              style="margin-top: 0.5rem;"
            >
              Enviar Sugestão
            </button>
          </form>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <p>© 2025 Plataforma M - MVP</p>
  </footer>

  <audio
    id="successSound"
    src="/static/sounds/success.mp3"
    preload="auto"
    style="display:none;"
  ></audio>

  <script>
    const isSolucionador = {{ 'true' if session.get("role") == "solucionador" else 'false' }};
    const userIsLoggedIn = {{ 'true' if session.get("user_id") else 'false' }};

    function revealStepSimple(stepDiv, stepNumber, stepData) {
      const titleBlock = document.createElement('div');
      titleBlock.classList.add('step-title-block');
      titleBlock.textContent = `Passo ${stepNumber}: ${stepData.stepTitle}`;
      stepDiv.appendChild(titleBlock);

      const descBlock = document.createElement('div');
      descBlock.classList.add('step-description-block');
      descBlock.textContent = stepData.stepDescription;
      stepDiv.appendChild(descBlock);

      if (stepData.stepImage && stepData.stepImage.trim() !== "") {
        const imageContainer = document.createElement('div');
        imageContainer.classList.add('step-image-block');
        const imgEl = document.createElement('img');
        imgEl.src = `/gridfs_image/${stepData.stepImage}`;
        imgEl.alt = "Imagem do Passo";
        imageContainer.appendChild(imgEl);
        stepDiv.appendChild(imageContainer);
      }

      if (stepData.miniSteps && stepData.miniSteps.length > 0) {
        const miniStepsWrapper = document.createElement('div');
        miniStepsWrapper.classList.add('mini-steps-block');
        stepDiv.appendChild(miniStepsWrapper);

        stepData.miniSteps.forEach((sub, subIndex) => {
          const miniStepContainer = document.createElement('div');
          miniStepContainer.classList.add('mini-step-container');

          const subTitle = document.createElement('div');
          subTitle.classList.add('mini-step-title');
          subTitle.textContent = `Passo ${stepNumber}.${subIndex + 1} - ${sub.miniStepTitle}`;
          miniStepContainer.appendChild(subTitle);

          const subDesc = document.createElement('div');
          subDesc.classList.add('mini-step-description');
          subDesc.textContent = sub.miniStepDescription;
          miniStepContainer.appendChild(subDesc);

          if (sub.subStepImage && sub.subStepImage.trim() !== "") {
            const subImgContainer = document.createElement('div');
            subImgContainer.classList.add('mini-step-image-block');
            const subImgEl = document.createElement('img');
            subImgEl.src = `/gridfs_image/${sub.subStepImage}`;
            subImgEl.alt = "Imagem do Subpasso";
            subImgContainer.appendChild(subImgEl);
            miniStepContainer.appendChild(subImgContainer);
          }
          miniStepsWrapper.appendChild(miniStepContainer);
        });

        let currentMiniStepIndex = 0;
        const btnShowMiniStep = document.createElement('button');
        btnShowMiniStep.classList.add('mini-steps-btn');
        btnShowMiniStep.textContent = "Mostrar Passo " + stepNumber + ".1";
        stepDiv.appendChild(btnShowMiniStep);

        btnShowMiniStep.addEventListener('click', () => {
          const miniContainers = miniStepsWrapper.querySelectorAll('.mini-step-container');
          if (currentMiniStepIndex < miniContainers.length) {
            miniContainers[currentMiniStepIndex].style.display = 'block';
            currentMiniStepIndex++;
            if (currentMiniStepIndex < miniContainers.length) {
              btnShowMiniStep.textContent = `Mostrar subpasso ${stepNumber}.${currentMiniStepIndex + 1}`;
            } else {
              btnShowMiniStep.style.display = 'none';
            }
          }
        });
      }
    }

    function renderSolutionNoAnimation(stepsOutput, stepsData) {
      stepsData.forEach((step, index) => {
        const stepDiv = document.createElement('div');
        stepDiv.classList.add('step-container');
        stepsOutput.appendChild(stepDiv);

        const titleBlock = document.createElement('div');
        titleBlock.classList.add('step-title-block');
        titleBlock.textContent = `Passo ${index + 1}: ${step.stepTitle}`;
        stepDiv.appendChild(titleBlock);

        const descBlock = document.createElement('div');
        descBlock.classList.add('step-description-block');
        descBlock.textContent = step.stepDescription;
        stepDiv.appendChild(descBlock);

        if (step.stepImage && step.stepImage.trim() !== "") {
          const imageContainer = document.createElement('div');
          imageContainer.classList.add('step-image-block');
          const imgEl = document.createElement('img');
          imgEl.src = `/gridfs_image/${step.stepImage}`;
          imgEl.alt = "Imagem do Passo";
          imageContainer.appendChild(imgEl);
          stepDiv.appendChild(imageContainer);
        }

        if (step.miniSteps && step.miniSteps.length > 0) {
          const miniStepsWrapper = document.createElement('div');
          miniStepsWrapper.classList.add('mini-steps-block');
          stepDiv.appendChild(miniStepsWrapper);

          step.miniSteps.forEach((sub, subIndex) => {
            const miniStepContainer = document.createElement('div');
            miniStepContainer.classList.add('mini-step-container');
            miniStepContainer.style.display = 'block';

            const subTitle = document.createElement('div');
            subTitle.classList.add('mini-step-title');
            subTitle.textContent = `Passo ${index + 1}.${subIndex + 1} - ${sub.miniStepTitle}`;
            miniStepContainer.appendChild(subTitle);

            const subDesc = document.createElement('div');
            subDesc.classList.add('mini-step-description');
            subDesc.textContent = sub.miniStepDescription;
            miniStepContainer.appendChild(subDesc);

            if (sub.subStepImage && sub.subStepImage.trim() !== "") {
              const subImgContainer = document.createElement('div');
              subImgContainer.classList.add('mini-step-image-block');
              const subImgEl = document.createElement('img');
              subImgEl.src = `/gridfs_image/${sub.subStepImage}`;
              subImgEl.alt = "Imagem do Subpasso";
              subImgContainer.appendChild(subImgEl);
              miniStepContainer.appendChild(subImgContainer);
            }
            miniStepsWrapper.appendChild(miniStepContainer);
          });
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const solutionContainer = document.getElementById('solutionContainer');
      const stepsData = JSON.parse(solutionContainer.dataset.steps || '[]');
      const stepsOutput = solutionContainer.querySelector('.steps-output');
      const problemID = solutionContainer.dataset.problemId;

      const btnShowSolution = document.getElementById('btnShowSolution');
      const feedbackButtons = document.getElementById('feedbackButtons');
      const btnConsegui = document.getElementById('btnConsegui');
      const btnNaoConsegui = document.getElementById('btnNaoConsegui');
      const failFeedbackForm = document.getElementById('failFeedbackForm');
      const btnEnviarFeedback = document.getElementById('btnEnviarFeedback');
      const failFeedbackText = document.getElementById('failFeedbackText');

      const progressBar = document.getElementById('progressBar');
      const progressInfo = document.getElementById('progressInfo');

      const btnOpenSuggestionModal = document.getElementById('btnOpenSuggestionModal');
      const btnCloseSuggestionModal = document.getElementById('btnCloseSuggestionModal');
      const suggestionModal = document.getElementById('suggestionModal');

      const btnHelpfulSim = document.getElementById('btnHelpfulSim');
      const btnHelpfulNao = document.getElementById('btnHelpfulNao');

      let currentStepIndex = 0;
      let totalSteps = stepsData.length;
      let isSolutionActive = false;

      if (totalSteps > 0) {
        progressInfo.textContent = `0 de ${totalSteps} Passos`;
      } else {
        progressInfo.textContent = "Nenhum passo definido.";
      }

      function updateProgressBar() {
        const percent = (currentStepIndex / totalSteps) * 100;
        progressBar.style.width = `${percent}%`;
        progressInfo.textContent = `${currentStepIndex} de ${totalSteps} Passos`;
      }

      function showCurrentStep() {
        if (currentStepIndex >= totalSteps) {
          progressBar.style.width = "100%";
          progressInfo.textContent = `${totalSteps} de ${totalSteps} Passos (Concluídos!)`;
          feedbackButtons.style.display = 'none';

          const finishMsg = document.createElement('p');
          finishMsg.style.textAlign = 'center';
          finishMsg.style.fontSize = '1.1rem';
          finishMsg.style.color = '#0a0';
          finishMsg.style.fontWeight = 'bold';
          finishMsg.textContent = "Parabéns, você concluiu todos os passos!";
          stepsOutput.appendChild(finishMsg);
          return;
        }

        const stepDiv = document.createElement('div');
        stepDiv.classList.add('step-container');
        stepsOutput.appendChild(stepDiv);

        revealStepSimple(stepDiv, currentStepIndex + 1, stepsData[currentStepIndex]);

        feedbackButtons.style.display = 'flex';
        failFeedbackForm.style.display = 'none';
        failFeedbackText.value = '';

        updateProgressBar();
      }

      btnConsegui.addEventListener('click', () => {
        const stepContainers = document.querySelectorAll('.step-container');
        if (stepContainers[currentStepIndex]) {
          const checkIcon = document.createElement('div');
          checkIcon.classList.add('step-check-icon');
          checkIcon.textContent = '✔';
          stepContainers[currentStepIndex].appendChild(checkIcon);
        }
        feedbackButtons.style.display = 'none';
        currentStepIndex++;
        showCurrentStep();
      });

      btnNaoConsegui.addEventListener('click', () => {
        btnNaoConsegui.classList.add('shake');
        setTimeout(() => {
          btnNaoConsegui.classList.remove('shake');
        }, 500);
        failFeedbackForm.style.display = 'block';
      });

      btnEnviarFeedback.addEventListener('click', () => {
        const feedbackVal = failFeedbackText.value.trim();
        if (!userIsLoggedIn) {
          // Se não estiver logado, simplesmente pula para o próximo passo
          failFeedbackForm.style.display = 'none';
          feedbackButtons.style.display = 'none';
          currentStepIndex++;
          showCurrentStep();
          return;
        }
        fetch("/submit_step_feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            problem_id: problemID,
            step_index: currentStepIndex,
            success: false,
            feedback_text: feedbackVal
          })
        })
        .then(resp => resp.json())
        .then(data => {
          console.log("Feedback Enviado:", data);
        })
        .catch(err => console.error("Erro ao enviar feedback:", err))
        .finally(() => {
          failFeedbackForm.style.display = 'none';
          feedbackButtons.style.display = 'none';
          currentStepIndex++;
          showCurrentStep();
        });
      });

      if (isSolucionador) {
        // Solucionador vê tudo expandido automaticamente
        renderSolutionNoAnimation(stepsOutput, stepsData);
        progressBar.style.width = "100%";
        if (totalSteps > 0) {
          progressInfo.textContent = `${totalSteps} de ${totalSteps} Passos (Modo Solucionador)`;
        } else {
          progressInfo.textContent = "Nenhum passo definido.";
        }
        btnShowSolution.style.display = 'none';
        feedbackButtons.style.display = 'none';
      } else {
        // Usuário comum: botão "Mostrar Passos"
        if (totalSteps === 0) {
          return;
        }
        btnShowSolution.style.display = 'inline-block';
        btnShowSolution.addEventListener('click', () => {
          if (isSolutionActive) return;
          isSolutionActive = true;
          btnShowSolution.style.display = 'none';
          showCurrentStep();
        });
      }

      function toggleHelpful(feedbackType) {
        if (!userIsLoggedIn) {
          alert("É necessário estar logado para registrar o feedback.");
          return;
        }
        fetch("/toggle_helpful", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            problem_id: problemID,
            feedback: feedbackType
          })
        })
        .then(resp => resp.json())
        .then(data => {
          if (data.error) {
            alert(data.error);
            return;
          }
          btnHelpfulSim.classList.remove("selected");
          btnHelpfulNao.classList.remove("selected");
          if (data.feedback === "SIM") {
            btnHelpfulSim.classList.add("selected");
          } else if (data.feedback === "NAO") {
            btnHelpfulNao.classList.add("selected");
          }
        })
        .catch(err => console.error("Erro ao enviar helpful feedback:", err));
      }

      btnHelpfulSim.addEventListener("click", () => toggleHelpful("SIM"));
      btnHelpfulNao.addEventListener("click", () => toggleHelpful("NAO"));

      btnOpenSuggestionModal.addEventListener("click", () => {
        if (!userIsLoggedIn) {
          alert("É necessário estar logado para enviar sugestões.");
          return;
        }
        suggestionModal.style.display = "flex";
      });

      btnCloseSuggestionModal.addEventListener("click", () => {
        suggestionModal.style.display = "none";
      });

      window.addEventListener("click", (event) => {
        if (event.target === suggestionModal) {
          suggestionModal.style.display = "none";
        }
      });
    });
  </script>
</body>
</html>
