<!-- solucao.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>M - Solu√ß√£o do Problema</title>
  <!-- Fonte b√°sica -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap"
    rel="stylesheet"
  />
  <!-- √çcones Material -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
  />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!--
    Meta tags para compartilhamento no Facebook (Open Graph)
    Adicionamos "Confira a solu√ß√£o do M para:" antes do t√≠tulo e da descri√ß√£o.
  -->
  <meta property="og:title" content="Confira a solu√ß√£o do M para: {{ problema['titulo'] }}">
  <meta property="og:description" content="{{ problema['descricao'] }} (via Plataforma M)">
  <meta property="og:image" content="{{ problem_image_url }}">
  <meta property="og:url" content="{{ share_url }}">
  <meta property="og:type" content="website">

  <style>
    /* Reset e estilos b√°sicos */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Roboto', sans-serif;
      font-size: 1rem;
      color: #333;
      background-color: #f0f0f0;
      overflow-x: hidden;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Preloader */
    #preloader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: #000;
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #333;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    /* Conte√∫do que ser√° exibido ap√≥s preloader */
    #content {
      transition: opacity 0.5s ease;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      opacity: 0; /* come√ßa invis√≠vel, depois faz fade-in */
    }

    /* HEADER */
    header {
      background-color: #000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
      height: 80px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    header h1 {
      color: #fff;
      font-size: 1.15rem;
      margin: 0;
      text-align: center;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }
    @media (max-width: 768px) {
      header {
        height: 56px;
        padding: 0 1rem;
      }
      header h1 {
        font-size: 1.3rem;
      }
    }
    .header-btn {
      background: none;
      border: none;
      cursor: pointer;
      outline: none;
      color: #fff;
      display: flex;
      align-items: center;
      text-decoration: none;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      transition: background-color 0.2s;
    }
    .header-btn:hover {
      background-color: #333;
    }
    .header-btn svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }
    .header-btn span {
      margin-left: 0.5rem;
    }
    @media (max-width: 768px) {
      .perfil-btn,
      .entrar-btn {
        display: none !important;
      }
    }

    /* MAIN */
    main {
      flex: 1;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      margin-top: 100px; /* espa√ßo para o header fixo */
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      font-size: 1.25rem;
    }
    @media (max-width: 768px) {
      main {
        margin-top: 72px;
        padding: 1rem;
        font-size: 1rem;
      }
    }

    /* FOOTER */
    footer {
      background-color: #000;
      text-align: center;
      padding: 1rem 2rem;
    }
    footer p {
      font-size: 0.9rem;
      color: #fff;
    }

    /* Barra inferior (mobile) */
    .mobile-bottom-bar {
      display: none;
    }
    @media (max-width: 768px) {
      .mobile-bottom-bar {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        background-color: #000;
        width: 100%;
        position: fixed;
        bottom: 0;
        left: 0;
        height: 60px;
        z-index: 9999;
      }
      .mobile-bottom-bar .bottom-bar-btn {
        text-align: center;
        color: #fff;
        text-decoration: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 0.8rem;
        justify-content: center;
      }
      .mobile-bottom-bar .bottom-bar-btn img {
        margin-bottom: 2px;
      }
      main {
        padding-bottom: 60px;
      }
    }
    .bottom-bar-btn.active {
      background-color: #444;
    }

    /* Container do problema */
    .problem-container {
      width: 100%;
      margin-top: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 2rem;
      background-color: #fff;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .creator-container,
    .solver-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 0.5rem;
    }
    .profile-pic {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 0.4rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    .creator-link,
    .solver-link {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: inherit;
    }
    .creator-link:hover,
    .solver-link:hover {
      opacity: 0.85;
    }

    .problem-container h2 {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
      color: #000;
      text-align: center;
    }
    .problem-container p.description {
      color: #555;
      margin-bottom: 0.5rem;
      text-align: center;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
      margin-bottom: 2rem;
    }
    @media (max-width: 768px) {
      .problem-container h2 {
        font-size: 1.2rem;
      }
    }
    .problem-image {
      display: block;
      margin: 1rem auto;
      width: 100%;
      max-width: 400px;
      height: auto;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .default-btn {
      background-color: #000;
      color: #fff;
      border: none;
      border-radius: 32px;
      padding: 0.6rem 1.2rem;
      font-size: 0.9rem;
      cursor: pointer;
      text-decoration: none;
      font-weight: 500;
      transition: background-color 0.2s, transform 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .default-btn:hover {
      background-color: #333;
      transform: scale(1.02);
    }

    .solution-container {
      width: 100%;
      margin-top: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 2rem;
      background-color: #fff;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .solution-container h3 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      color: #000;
      font-weight: 700;
      text-align: center;
    }
    @media (max-width: 768px) {
      .solution-container h3 {
        font-size: 1.2rem;
      }
    }

    #btnShowSolution {
      margin: 1rem 0;
    }
    .progress-container {
      position: relative;
      width: 100%;
      max-width: 600px;
      height: 20px;
      background-color: #eee;
      border-radius: 10px;
      margin: 1rem auto 0;
    }
    .progress-bar {
      height: 100%;
      background-color: #00b300;
      width: 0%;
      border-radius: 10px;
      transition: width 0.4s ease;
    }
    .progress-info {
      text-align: center;
      font-size: 1rem;
      color: #555;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
    }
    .steps-output {
      margin-top: 2rem;
      line-height: 1.7;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 1rem;
      margin-bottom: 2.5rem;
      min-height: 80px;
      color: #333;
      max-width: 1100px;
      margin-left: auto;
      margin-right: auto;
    }
    .step-container {
      margin-bottom: 2rem;
      padding: 1rem 1rem 2rem;
      border-left: 4px solid #000;
      background-color: #fafafa;
      transition: background-color 0.2s ease-in-out;
      max-width: 1100px;
      margin-left: auto;
      margin-right: auto;
      position: relative;
    }
    .step-title-block {
      font-size: 1.2rem;
      color: #000;
      margin-bottom: 0.8rem;
      font-weight: bold;
    }
    .step-description-block {
      color: #444;
      margin-bottom: 1rem;
      white-space: pre-wrap;
      line-height: 1.6;
    }
    .step-image-block {
      text-align: center;
      margin-bottom: 1rem;
    }
    .step-image-block img {
      max-width: 400px;
      width: 100%;
      height: auto;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 0.5rem;
    }
    .step-check-icon {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      font-size: 2rem;
      color: #0a0;
      opacity: 0.8;
    }
    .mini-steps-block {
      margin-left: 1rem;
      margin-top: 1rem;
      border-left: 3px dashed #333;
      padding-left: 1rem;
    }
    .mini-step-container {
      margin-bottom: 1.5rem;
      display: none;
    }
    .mini-step-title {
      font-size: 1.1rem;
      color: #333;
      font-weight: bold;
      margin-bottom: 0.3rem;
      display: block;
    }
    .mini-step-description {
      font-size: 1rem;
      color: #555;
      white-space: pre-wrap;
      margin-bottom: 0.5rem;
      display: block;
      line-height: 1.5;
    }
    .mini-step-image-block {
      text-align: center;
      margin-bottom: 1rem;
    }
    .mini-step-image-block img {
      max-width: 400px;
      width: 100%;
      height: auto;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 0.5rem;
    }
    .mini-steps-btn {
      margin: 0.5rem 0;
    }
    .feedback-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1rem;
    }
    .shake {
      animation: shake 0.5s;
    }
    @keyframes shake {
      0% { transform: translate(0, 0); }
      20% { transform: translate(-5px, 0); }
      40% { transform: translate(5px, 0); }
      60% { transform: translate(-5px, 0); }
      80% { transform: translate(5px, 0); }
      100% { transform: translate(0, 0); }
    }
    .fail-feedback-form {
      text-align: center;
      margin-top: 1rem;
      display: none;
    }
    .fail-feedback-form textarea {
      width: 100%;
      max-width: 600px;
      height: 80px;
      margin-bottom: 0.5rem;
      font-size: 1rem;
      padding: 0.5rem;
    }
    .fail-feedback-thank {
      font-size: 0.95rem;
      color: #666;
      margin-top: 0.5rem;
    }
    .feedback-container {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      background-color: #fff;
      text-align: center;
      max-width: 600px;
      width: 100%;
    }
    .helpful-question p {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: #333;
      font-weight: 500;
    }
    .helpful-feedback-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }
    .helpful-btn.selected {
      background-color: #333 !important;
      transform: none !important;
      color: #fff !important;
    }

    /* Modal de sugest√£o de melhorias */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: #f7f7f7;
      width: 95%;
      max-width: 700px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      animation: modalFadeIn 0.3s ease;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
      overflow: hidden;
      border: 1px solid #fff;
    }
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .modal-header {
      background-color: #000;
      color: #fff;
      padding: 2rem;
      position: relative;
      border-bottom: 1px solid #333;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 2rem;
      font-weight: 500;
    }
    .close {
      color: #fff;
      position: absolute;
      right: 2rem;
      top: 2rem;
      font-size: 2.4rem;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
    }
    .close:hover {
      color: #ccc;
    }
    .modal-body {
      padding: 2rem;
      text-align: center;
      overflow-y: auto;
      max-height: calc(90vh - 100px);
    }

    /* Modal de compartilhamento */
    #shareSolutionModalContent {
      background-color: #fff;
      width: 95%;
      max-width: 350px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      animation: modalFadeIn 0.3s ease;
      display: flex;
      flex-direction: column;
      border: 1px solid #fff;
      position: relative;
    }
    #shareSolutionModalHeader {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #000;
      color: #fff;
      padding: 1rem;
    }
    #shareSolutionModalHeader h2 {
      margin: 0;
      font-size: 1.25rem;
    }
    #closeShareSolutionModal {
      position: absolute;
      right: 1rem;
      top: 1rem;
      background: none;
      color: #fff;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }
    #shareSolutionModalBody {
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .share-option-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.6rem;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
    }
    .share-option-btn svg {
      margin-right: 8px;
      fill: currentColor;
    }
    .share-option-btn.whatsapp {
      background-color: #25D366;
    }
    .share-option-btn.facebook {
      background-color: #1877F2;
    }
    .share-option-btn.instagram {
      background: linear-gradient(45deg, #f09433, #bc1888);
    }
    .share-option-btn.native-share {
      background-color: #333;
    }
    .share-option-btn.copy-link-btn {
      background-color: #777;
    }

    /* Se√ß√£o de Afiliados */
    .affiliate-section {
      width: 100%;
      margin-top: 1rem;
      margin-bottom: 1rem;
      padding: 1rem;
      background-color: #fafafa;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .affiliate-section h4 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      text-align: center;
      color: #000;
    }
    .affiliate-links-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }
    .affiliate-card {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }
    .affiliate-card img {
      width: 100%;
      max-width: 200px;
      height: auto;
      margin-bottom: 0.5rem;
      object-fit: contain;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .affiliate-card h5 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
      color: #333;
      font-weight: bold;
    }
    .affiliate-card a {
      display: inline-block;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #fff;
      background-color: #000;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      text-decoration: none;
      transition: background-color 0.2s;
    }
    .affiliate-card a:hover {
      background-color: #333;
    }
    .remove-link-btn {
      margin-top: 0.7rem;
      font-size: 0.8rem;
      background-color: #cc0000;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 0.3rem 0.7rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .remove-link-btn:hover {
      background-color: #aa0000;
    }

    /* Modal de adicionar link de afiliado */
    #addAffiliateLinkModalContent {
      background-color: #fff;
      width: 95%;
      max-width: 600px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      animation: modalFadeIn 0.3s ease;
      display: flex;
      flex-direction: column;
      border: 1px solid #fff;
      position: relative;
    }
    #addAffiliateLinkModalHeader {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #000;
      color: #fff;
      padding: 1rem;
    }
    #addAffiliateLinkModalHeader h2 {
      margin: 0;
      font-size: 1.25rem;
    }
    #closeAddAffiliateLinkModal {
      position: absolute;
      right: 1rem;
      top: 1rem;
      background: none;
      color: #fff;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }
    #addAffiliateLinkModalBody {
      padding: 1rem 2rem;
    }
    #addAffiliateLinkModalBody label {
      display: block;
      margin: 0.5rem 0 0.2rem;
      font-weight: 500;
      font-size: 0.9rem;
    }
    #addAffiliateLinkModalBody input[type="text"],
    #addAffiliateLinkModalBody input[type="url"],
    #addAffiliateLinkModalBody input[type="file"] {
      width: 100%;
      margin-bottom: 0.8rem;
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #addAffiliateLinkModalBody .default-btn {
      display: inline-block;
      margin: 0.5rem 0;
    }
  </style>
</head>
<body>
  <!-- PRELOADER -->
  <div id="preloader">
    <div class="loader"></div>
  </div>

  <!-- CONTE√öDO -->
  <div id="content">
    <!-- Barra superior fixa -->
    <header>
      <!-- Bot√£o "Voltar" -->
      <button
        class="header-btn"
        id="btnVoltar"
        aria-label="Voltar"
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path
            d="M15 18l-6-6 6-6"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </button>

      <h1>Detalhes e Solu√ß√£o</h1>

      <!-- Se N√ÉO estiver logado, mostra "Entrar" -->
      {% if not session.get('user_id') %}
        <a class="header-btn entrar-btn" href="{{ url_for('login') }}">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 16 16"
          >
            <path d="M8 8a3 3 0 1 0-3-3 3 3 0 0 0 3 3z" />
            <path
              d="M8 8c-2.33 0-4 1.67-4 4v1h8v-1c0-2.33-1.67-4-4-4z"
            />
          </svg>
          <span>Entrar</span>
        </a>
      {% else %}
        <!-- Se estiver logado, mostra "Perfil" -->
        <a class="header-btn perfil-btn" href="{{ url_for('perfil') }}">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 16 16"
          >
            <path d="M8 8a3 3 0 1 0-3-3 3 3 0 0 0 3 3z" />
            <path
              d="M8 8c-2.33 0-4 1.67-4 4v1h8v-1c0-2.33-1.67-4-4-4z"
            />
          </svg>
          <span>Perfil</span>
        </a>
      {% endif %}
    </header>

    <main>
      <!-- Container do problema -->
      <div class="problem-container">
        <!-- Enviado por (igual padr√£o da p√°gina de resultados) -->
        <div class="creator-container">
          {% if creator_id %}
            <a href="{{ url_for('ver_usuario', user_id=creator_id) }}" class="creator-link">
              {% if creator_profile_image_id %}
                <img
                  src="{{ url_for('get_user_photo', file_id=creator_profile_image_id) }}"
                  alt="Foto de perfil do criador"
                  class="profile-pic"
                />
              {% else %}
                <img
                  src="{{ url_for('static', filename='images/avatar_icon.webp') }}"
                  alt="Foto de perfil padr√£o"
                  class="profile-pic"
                />
              {% endif %}
              <p><strong>Enviado por:</strong> {{ creator_name }}</p>
            </a>
          {% else %}
            <!-- Criador custom name ou sem ID -->
            {% if creator_profile_image_id %}
              <img
                src="{{ url_for('get_user_photo', file_id=creator_profile_image_id) }}"
                alt="Foto de perfil do criador"
                class="profile-pic"
              />
              <p><strong>Enviado por:</strong> {{ creator_name }}</p>
            {% else %}
              <img
                src="{{ url_for('static', filename='images/avatar_icon.webp') }}"
                alt="Foto de perfil padr√£o"
                class="profile-pic"
              />
              <p><strong>Enviado por:</strong> {{ creator_name }}</p>
            {% endif %}
          {% endif %}
        </div>

        <h2>{{ problema["titulo"] }}</h2>
        <p class="description">{{ problema["descricao"] }}</p>

        {% if problema.problemImage_main %}
          <img
            src="{{ url_for('gridfs_image', file_id=problema.problemImage_main) }}"
            alt="Imagem do Problema"
            class="problem-image"
          />
        {% endif %}

        <!-- Bot√£o para abrir modal de compartilhamento -->
        <div style="text-align: center; margin-top: 1rem;">
          <button
            class="default-btn"
            style="margin: 1rem auto;"
            id="openShareSolutionModalBtn"
            data-solutionurl="{{ share_url }}"
            data-problemtitle="{{ problema['titulo'] }}"
          >
            <svg
              width="18"
              height="18"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 512 512"
              style="fill: currentColor;"
            >
              <path
                d="M503.691 189.836l-192-160C302.126 25.161
                298.063 24 294.071 24c-4.275 0-8.531 1.242-12.266
                3.773C272.161 36.881 272 41.719 272 46.312V128C128
                128 64 173.568 64 320c0 63.551 31.362 85.719 49.703
                92.137 5.289 1.856 11.183 2.789 16.787 2.789
                9.189 0 18.264-2.183 26.361-6.531 12.195-6.52
                19.149-19.364 17.232-33.121C168.98 308.02
                201.047 270.581 272 256v81.688c0 4.593.161
                9.431 9.805 18.539C285.54 359.758 289.796
                361 294.07 361c3.992 0 8.055-1.161
                11.625-3.77l192-160c3.773-3.156 5.305-7.772
                5.305-12.23S507.464 192.992 503.691 189.836zM256 334
                c-43.1 0-78-34.9-78-78s34.9-78 78-78 78 34.9 78 78-34.9 78-78 78z"
              />
            </svg>
            Compartilhar Solu√ß√£o
          </button>
        </div>
      </div>

      <!-- Se√ß√£o de afiliados: "Pe√ßas e ferramentas que voc√™ pode precisar" -->
      <div class="affiliate-section">
        <h4>Pe√ßas e ferramentas que voc√™ pode precisar</h4>

        <div class="affiliate-links-container">
          {% if affiliate_links and affiliate_links|length > 0 %}
            {% for link in affiliate_links %}
              <div class="affiliate-card">
                {% if link.productImage_main %}
                  <img
                    src="{{ url_for('gridfs_image', file_id=link.productImage_main) }}"
                    alt="Imagem do produto"
                  />
                {% endif %}
                <h5>{{ link.title }}</h5>
                <a
                  href="{{ link.affiliate_url }}"
                  target="_blank"
                  rel="noopener nofollow"
                >
                  Comprar agora
                </a>
                {% if session.get("role") == "solucionador" %}
                  <form
                    action="{{ url_for('remove_affiliate_link', link_id=link._id_str) }}"
                    method="POST"
                  >
                    <button
                      type="submit"
                      class="remove-link-btn"
                    >
                      Remover
                    </button>
                  </form>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <p style="text-align: center; color: #666;">(Nenhum item adicionado.)</p>
          {% endif %}
        </div>

        <!-- Bot√£o para abrir modal de adicionar link (somente para solucionadores) -->
        {% if session.get("role") == "solucionador" %}
          <div style="text-align:center; margin-top:1.5rem;">
            <button
              type="button"
              class="default-btn"
              id="btnOpenAddAffiliateLinkModal"
            >
              + Adicionar Link de Afiliado
            </button>
          </div>
        {% endif %}
      </div>

      <!-- (Removida a linha de separa√ß√£o aqui) -->

      <!-- Container da solu√ß√£o -->
      <div
        class="solution-container"
        id="solutionContainer"
        data-steps='{{ solucao.get("steps", [])|tojson }}'
        data-problem-id="{{ problema['_id'] }}"
      >
        <!-- "Resolvido por:" fica aqui, acima do t√≠tulo da solu√ß√£o -->
        <div class="solver-container">
          {% if solver_id %}
            <a href="{{ url_for('ver_usuario', user_id=solver_id) }}" class="solver-link">
              {% if solver_profile_image_id %}
                <img
                  src="{{ url_for('get_user_photo', file_id=solver_profile_image_id) }}"
                  alt="Foto de perfil do solucionador"
                  class="profile-pic"
                />
              {% else %}
                <img
                  src="{{ url_for('static', filename='images/avatar_icon.webp') }}"
                  alt="Foto de perfil padr√£o"
                  class="profile-pic"
                />
              {% endif %}
              <p><strong>Resolvido por:</strong> {{ solver_name }}</p>
            </a>
          {% else %}
            {% if solver_profile_image_id %}
              <img
                src="{{ url_for('get_user_photo', file_id=solver_profile_image_id) }}"
                alt="Foto de perfil do solucionador"
                class="profile-pic"
              />
              <p><strong>Resolvido por:</strong> {{ solver_name }}</p>
            {% else %}
              <img
                src="{{ url_for('static', filename='images/avatar_icon.webp') }}"
                alt="Foto de perfil padr√£o"
                class="profile-pic"
              />
              <p><strong>Resolvido por:</strong> {{ solver_name }}</p>
            {% endif %}
          {% endif %}
        </div>

        <h3>Solu√ß√£o Completa:</h3>

        <!-- Apenas aparece se o usu√°rio N√ÉO for solucionador, para mostrar passo-a-passo -->
        <button
          type="button"
          class="default-btn"
          id="btnShowSolution"
          style="display: none;"
        >
          Mostrar Passos
        </button>

        <div class="steps-output"></div>

        <div class="feedback-buttons" id="feedbackButtons" style="display: none;">
          <button type="button" class="default-btn" id="btnConsegui">‚úÖ Consegui!</button>
          <button type="button" class="default-btn" id="btnNaoConsegui">‚ùå N√£o Consegui</button>
        </div>

        <div class="fail-feedback-form" id="failFeedbackForm">
          <textarea
            id="failFeedbackText"
            placeholder="Descreva o que houve dificuldade..."
          ></textarea>
          <br />
          <button type="button" class="default-btn" id="btnEnviarFeedback">Enviar Feedback</button>
          <div class="fail-feedback-thank">
            Seu feedback nos ajuda a melhorar a plataforma! üòä
          </div>
        </div>

        <div class="progress-container" id="progressContainer">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="progress-info" id="progressInfo">0 de 0 Passos</div>
      </div>

      <!-- BOT√ÉO "EDITAR SOLU√á√ÉO" (APENAS PARA SOLUCIONADORES) -->
      {% if session.get("role") == "solucionador" %}
        <div style="text-align: center; margin-top: 1rem;">
          <a
            href="{{ url_for('edit_solution', problem_id=problema['_id']) }}"
            class="default-btn"
          >
            Editar Solu√ß√£o
          </a>
        </div>
      {% endif %}

      <!-- Container para feedback da solu√ß√£o (like/dislike) -->
      <div class="feedback-container">
        <div class="helpful-question">
          <p>Essa solu√ß√£o te ajudou?</p>
          <div class="helpful-feedback-buttons">
            <button
              type="button"
              class="default-btn {% if user_helpful_feedback == 'SIM' %}selected{% endif %}"
              id="btnHelpfulSim"
            >
              üëç Sim
            </button>
            <button
              type="button"
              class="default-btn {% if user_helpful_feedback == 'NAO' %}selected{% endif %}"
              id="btnHelpfulNao"
            >
              üëé N√£o
            </button>
          </div>
          <button
            type="button"
            class="default-btn"
            id="btnOpenSuggestionModal"
            style="margin-top: 1rem;"
          >
            üí° Sugerir melhorias
          </button>
        </div>
      </div>
    </main>

    <footer>
      <p>¬© 2025 Plataforma M - MVP</p>
    </footer>

    <!-- Barra inferior (mobile) -->
    <div class="mobile-bottom-bar">
      <a
        href="{{ url_for('index') }}"
        class="bottom-bar-btn{% if request.endpoint == 'index' or request.endpoint == 'solucao' %} active{% endif %}"
        title="P√°gina Inicial"
      >
        <img
          src="{{ url_for('static', filename='images/home_icon.webp') }}"
          alt="Home Icon"
          style="width:30px;height:30px;margin-bottom:0px;"
        />
        Home
      </a>

      <a
        href="{{ url_for('unresolved') }}"
        class="bottom-bar-btn{% if request.endpoint == 'unresolved' %} active{% endif %}"
        title="Resolver Problemas"
      >
        <img
          src="{{ url_for('static', filename='images/resolver_icon.webp') }}"
          alt="Resolver Icon"
          style="width:30px;height:30px;margin-bottom:0px;"
        />
        Resolver
      </a>

      <a
        href="{{ url_for('add_problem') }}"
        class="bottom-bar-btn{% if request.endpoint == 'add_problem' %} active{% endif %}"
        title="Envie seu Problema"
      >
        <img
          src="{{ url_for('static', filename='images/enviar_icon.webp') }}"
          alt="Envie"
          style="width:30px; height:30px;"
        />
        Enviar
      </a>

      {% if not session.get('user_id') %}
        <a
          href="{{ url_for('login') }}"
          class="bottom-bar-btn{% if request.endpoint in ['login','register'] %} active{% endif %}"
          title="Entrar"
        >
          <img
            src="{{ url_for('static', filename='images/perfil_icon.webp') }}"
            alt="Perfil Icon"
            style="width:30px;height:30px;margin-bottom:0px;"
          />
          Entrar
        </a>
      {% else %}
        <a
          href="{{ url_for('perfil') }}"
          class="bottom-bar-btn{% if request.endpoint == 'perfil' %} active{% endif %}"
          title="Perfil"
        >
          <img
            src="{{ url_for('static', filename='images/perfil_icon.webp') }}"
            alt="Perfil Icon"
            style="width:30px;height:30px;margin-bottom:0px;"
          />
          Perfil
        </a>
      {% endif %}
    </div>
  </div>

  <!-- √Åudio de sucesso (opcional) -->
  <audio
    id="successSound"
    src="/static/sounds/success.mp3"
    preload="auto"
    style="display:none;"
  ></audio>

  <!-- Modal para compartilhar solu√ß√£o -->
  <div class="modal" id="shareSolutionModal">
    <div id="shareSolutionModalContent">
      <div id="shareSolutionModalHeader">
        <h2>Compartilhar Solu√ß√£o</h2>
        <button id="closeShareSolutionModal">&times;</button>
      </div>
      <div id="shareSolutionModalBody">
        <p style="font-size:1rem; margin-bottom:1rem;">Escolha como deseja compartilhar:</p>

        <button
          class="share-option-btn native-share"
          id="btnNativeShareSolution"
          style="display: none;"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 512 512"
            fill="currentColor"
          >
            <path
              d="M503.691 189.836l-192-160C302.126 25.161
                298.063 24 294.071 24c-4.275 0-8.531 1.242-12.266
                3.773C272.161 36.881 272 41.719 272 46.312V128C128
                128 64 173.568 64 320c0 63.551 31.362 85.719 49.703
                92.137 5.289 1.856 11.183 2.789 16.787 2.789
                9.189 0 18.264-2.183 26.361-6.531 12.195-6.52
                19.149-19.364 17.232-33.121C168.98 308.02
                201.047 270.581 272 256v81.688c0 4.593.161
                9.431 9.805 18.539C285.54 359.758 289.796
                361 294.07 361c3.992 0 8.055-1.161
                11.625-3.77l192-160c3.773-3.156 5.305-7.772
                5.305-12.23S507.464 192.992 503.691 189.836zM256 334
                c-43.1 0-78-34.9-78-78s34.9-78 78-78 78 34.9 78 78-34.9 78-78 78z"
            />
          </svg>
          Compartilhar via Dispositivo
        </button>

        <button class="share-option-btn whatsapp" id="btnShareSolutionWhatsApp">
          <svg
            width="20"
            height="20"
            fill="currentColor"
            viewBox="0 0 448 512"
          >
            <path
              d="M380.9 97.1C339 55.2 283.2 32 224 32 100.3 32
                0 132.3 0 256c0 45.4 11.8 89.3 34.3 128L0 480l100.6 -33.2
                c37.9 20.8 81 31.8 123.4 31.8h.1c124 0 224.4-100.3
                224.6-224.3.1-59.3-23-115.2 -67.8-159.2zM224.1 400
                c-35 0-69.2 -9.3-98.6-26.9l-6.9-4.1 -58.4 19.3
                19.6-57.1-4.5-7c-17.6-28 -26.8-60.4-26.8-93.8
                0-97.5 79.2-176.8 176.8-176.8
                47.2 0 91.6 18.4 124.9 51.7
                33.2 33.2 51.5 77.6 51.4 124.7
                -.2 97.5-79.4 176.7 -176.8 176.7zm101.7-131.5
                c-5.6-2.8-33.2-16.4 -38.4-18.2-5.1-1.9-8.8 -2.8
                -12.6 2.8-3.7 5.6-14.4 18.2-17.6 21.9
                -3.2 3.7 -6.5 4.2-12.1 1.4
                -5.6 -2.8-23.6-8.7-45-27.6
                -16.6-14.7-27.8-32.8 -31-38.4
                -3.2-5.6-.3-8.6 2.4-11.3
                2.5-2.5 5.6-6.5
                8.4-9.7
                s3.7-5.6 5.5-9.3c1.9-3.7.9-7-0.5 -9.8
                -1.4-2.8-12.6-30.4 -17.3-41.8
                -4.5-11-9-9.3-12.6-9.5
                -3.2-.2-7-.2-10.7-.2
                s-9.8 1.4 -15 6.9
                c-5.1 5.6-19.7 19.3-19.7 47.1
                s20.2 54.5 23 58.2
                c2.8 3.7 39.8 60.7 96.4 85.2
                13 5.8 23.8 9.3 31.9 11.9
                13.4 4.2 25.6 3.6 35.2 2.2
                10.7-1.6 33.2-13.5
                37.9-25.8
                4.7-13.2
                4.7-24.5 3.2-26.6
                -1.6-2.1-5.1-3.4 -10.7-6.2z"
            />
          </svg>
          WhatsApp
        </button>

        <button class="share-option-btn facebook" id="btnShareSolutionFacebook">
          <svg
            width="20"
            height="20"
            fill="white"
            viewBox="0 0 13 20"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M12.033.003H9.209C5.73.003 3.391 2.453 3.391 5.869v2.529H.566A.566.566 0 0 0 0 8.964v3.006c0
                .312.254.566.566.566h2.825v7.899c0
                .312.254.565.566.565h3.29c.312 0
                .566-.253.566-.565v-7.899h2.946a.566.566 0 0 0
                .565-.566l.001-3.006a.56.56 0 0 0-.166-.4.568.568 0 0 0-.399-.166H7.813V6.249c0-1.01.24-1.521
                1.55-1.521l1.9-.001a.566.566 0 0 0
                .566-.566V.568A.566.566 0 0 0 11.262 0h-.01l.781.003z"
            />
          </svg>
          Facebook
        </button>

        <button class="share-option-btn instagram" id="btnShareSolutionInstagram">
          <svg
            width="20"
            height="20"
            fill="currentColor"
            viewBox="0 0 448 512"
          >
            <path
              d="M224.1 141c-63.6 0-114.9
                51.3-114.9 114.9s51.3 114.9 114.9
                114.9 114.9-51.3 114.9-114.9S287.6
                141 224.1 141zm0
                190c-41.7 0-75.1-33.4-75.1-75.1
                0-41.7 33.4-75.1
                75.1-75.1 41.7 0 75.1 33.4
                75.1 75.1 0
                41.7-33.4 75.1-75.1
                75.1zm146.4-194.3c0
                14.9-12 26.9-26.9
                26.9-14.9 0-26.9-12-26.9-26.9
                0-14.9 12-26.9
                26.9-26.9 14.9 0
                26.9 12 26.9 26.9zm76.1
                27.2c-1.7-36.2-9.9-68.4-36.2-94.7s-58.5-34.5-94.7
                -36.2C290.9 32 284 32 224
                32s-66.9 0-88.5
                1.7c-36.2 1.7-68.4
                9.9-94.7 36.2S6.3
                128.5 4.6 164.7C2.9 186.3 2.9
                193.2 2.9 256s0
                69.7 1.7 91.3c1.7
                36.2 9.9 68.4
                36.2 94.7s58.5 34.5 94.7
                36.2c21.6 1.7 28.5
                1.7 88.5
                1.7s66.9 0
                88.5-1.7c36.2-1.7
                68.4-9.9
                94.7-36.2s34.5-58.5
                36.2-94.7c1.7-21.6
                1.7-28.5 1.7-88.5s0-66.9-1.7
                -88.5zM398.8
                388.4c-7.8
                19.6-22.9
                34.7-42.5
                42.5-29.4
                11.7-99.2
                9-132.3
                9s-102.9
                2.6-132.3-9c-19.6-7.8-34.7-22.9
                -42.5-42.5-11.7-29.4-9-99.2
                -9-132.3s-2.6-102.9
                9-132.3c7.8-19.6
                22.9-34.7 42.5-42.5
                29.4-11.7 99.2-9
                132.3-9s102.9-2.6
                132.3 9c19.6 7.8
                34.7 22.9
                42.5 42.5
                11.7 29.4
                9 99.2
                9 132.3s2.7
                102.9-9
                132.3z"
            />
          </svg>
          Instagram
        </button>

        <button class="share-option-btn copy-link-btn" id="btnCopySolutionLink">
          <svg
            width="20"
            height="20"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              d="M16 1H4c-1.103 0-2
                .897-2 2v14h2V3h12V1z"
            ></path>
            <path
              d="M18 5H8c-1.103
                0-2 .897-2 2v14c0 1.103.897
                2 2 2h10c1.103 0
                2-.897 2-2V7c0-1.103-.897-2-2-2zm0
                16H8V7h10v14z"
            ></path>
          </svg>
          Copiar Link
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de sugest√£o de melhorias -->
  <div id="suggestionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Sugerir Melhorias</h2>
        <span class="close" id="btnCloseSuggestionModal">&times;</span>
      </div>
      <div class="modal-body">
        <form
          action="{{ url_for('suggest_improvement', problem_id=problema['_id']) }}"
          method="POST"
        >
          <textarea
            name="suggestion"
            rows="5"
            placeholder="Descreva sua sugest√£o..."
            style="width: 100%; max-width:600px;"
          ></textarea>
          <br />
          <button
            type="submit"
            class="default-btn"
            style="margin-top: 0.5rem;"
          >
            Enviar Sugest√£o
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal para adicionar link de afiliado (somente solucionador) -->
  {% if session.get("role") == "solucionador" %}
    <div class="modal" id="addAffiliateLinkModal">
      <div id="addAffiliateLinkModalContent">
        <div id="addAffiliateLinkModalHeader">
          <h2>Adicionar Link de Afiliado</h2>
          <button id="closeAddAffiliateLinkModal">&times;</button>
        </div>
        <div id="addAffiliateLinkModalBody">
          <form
            action="{{ url_for('add_affiliate_link', problem_id=problema['_id']) }}"
            method="POST"
            enctype="multipart/form-data"
          >
            <label for="titleInput">T√≠tulo / Nome do Produto</label>
            <input
              type="text"
              id="titleInput"
              name="title"
              placeholder="Ex: Chave de fenda..."
              required
            />

            <label for="affiliateUrlInput">Link de Afiliado (URL)</label>
            <input
              type="url"
              id="affiliateUrlInput"
              name="affiliate_url"
              placeholder="Ex: https://amazon.com/dp/..."
              required
            />

            <label for="productImageFile">Imagem do Produto (opcional)</label>
            <input type="file" id="productImageFile" name="product_image" accept="image/*" />

            <button type="submit" class="default-btn">
              Adicionar Link
            </button>
          </form>
        </div>
      </div>
    </div>
  {% endif %}

  <script>
    // Preloader + fade-in do conte√∫do
    window.addEventListener('load', function () {
      const preloader = document.getElementById('preloader');
      const content = document.getElementById('content');
      if (preloader) {
        preloader.style.display = 'none';
      }
      if (content) {
        content.style.opacity = '1';
      }
    });

    const isSolucionador = {{ 'true' if session.get("role") == "solucionador" else 'false' }};
    const userIsLoggedIn = {{ 'true' if session.get("user_id") else 'false' }};

    // --------------------------------------------------------------------------------
    // L√≥gica de exibi√ß√£o da solu√ß√£o passo-a-passo
    // --------------------------------------------------------------------------------
    function revealStepSimple(stepDiv, stepNumber, stepData) {
      const titleBlock = document.createElement('div');
      titleBlock.classList.add('step-title-block');
      titleBlock.textContent = `Passo ${stepNumber}: ${stepData.stepTitle}`;
      stepDiv.appendChild(titleBlock);

      const descBlock = document.createElement('div');
      descBlock.classList.add('step-description-block');
      descBlock.textContent = stepData.stepDescription;
      stepDiv.appendChild(descBlock);

      if (stepData.stepImage && stepData.stepImage.trim() !== "") {
        const imageContainer = document.createElement('div');
        imageContainer.classList.add('step-image-block');
        const imgEl = document.createElement('img');
        imgEl.src = `/gridfs_image/${stepData.stepImage}`;
        imgEl.alt = "Imagem do Passo";
        imageContainer.appendChild(imgEl);
        stepDiv.appendChild(imageContainer);
      }

      if (stepData.miniSteps && stepData.miniSteps.length > 0) {
        const miniStepsWrapper = document.createElement('div');
        miniStepsWrapper.classList.add('mini-steps-block');
        stepDiv.appendChild(miniStepsWrapper);

        stepData.miniSteps.forEach((sub, subIndex) => {
          const miniStepContainer = document.createElement('div');
          miniStepContainer.classList.add('mini-step-container');

          const subTitle = document.createElement('div');
          subTitle.classList.add('mini-step-title');
          subTitle.textContent = `Passo ${stepNumber}.${subIndex + 1} - ${sub.miniStepTitle}`;
          miniStepContainer.appendChild(subTitle);

          const subDesc = document.createElement('div');
          subDesc.classList.add('mini-step-description');
          subDesc.textContent = sub.miniStepDescription;
          miniStepContainer.appendChild(subDesc);

          if (sub.subStepImage && sub.subStepImage.trim() !== "") {
            const subImgContainer = document.createElement('div');
            subImgContainer.classList.add('mini-step-image-block');
            const subImgEl = document.createElement('img');
            subImgEl.src = `/gridfs_image/${sub.subStepImage}`;
            subImgEl.alt = "Imagem do Subpasso";
            subImgContainer.appendChild(subImgEl);
            miniStepContainer.appendChild(subImgContainer);
          }
          miniStepsWrapper.appendChild(miniStepContainer);
        });

        let currentMiniStepIndex = 0;
        const btnShowMiniStep = document.createElement('button');
        btnShowMiniStep.classList.add('default-btn', 'mini-steps-btn');
        btnShowMiniStep.textContent = `Mostrar Passo ${stepNumber}.1`;
        stepDiv.appendChild(btnShowMiniStep);

        btnShowMiniStep.addEventListener('click', () => {
          const miniContainers = miniStepsWrapper.querySelectorAll('.mini-step-container');
          if (currentMiniStepIndex < miniContainers.length) {
            miniContainers[currentMiniStepIndex].style.display = 'block';
            currentMiniStepIndex++;
            if (currentMiniStepIndex < miniContainers.length) {
              btnShowMiniStep.textContent = `Mostrar subpasso ${stepNumber}.${currentMiniStepIndex + 1}`;
            } else {
              btnShowMiniStep.style.display = 'none';
            }
          }
        });
      }
    }

    function renderSolutionNoAnimation(stepsOutput, stepsData) {
      stepsData.forEach((step, index) => {
        const stepDiv = document.createElement('div');
        stepDiv.classList.add('step-container');
        stepsOutput.appendChild(stepDiv);

        const titleBlock = document.createElement('div');
        titleBlock.classList.add('step-title-block');
        titleBlock.textContent = `Passo ${index + 1}: ${step.stepTitle}`;
        stepDiv.appendChild(titleBlock);

        const descBlock = document.createElement('div');
        descBlock.classList.add('step-description-block');
        descBlock.textContent = step.stepDescription;
        stepDiv.appendChild(descBlock);

        if (step.stepImage && step.stepImage.trim() !== "") {
          const imageContainer = document.createElement('div');
          imageContainer.classList.add('step-image-block');
          const imgEl = document.createElement('img');
          imgEl.src = `/gridfs_image/${step.stepImage}`;
          imgEl.alt = "Imagem do Passo";
          imageContainer.appendChild(imgEl);
          stepDiv.appendChild(imageContainer);
        }

        if (step.miniSteps && step.miniSteps.length > 0) {
          const miniStepsWrapper = document.createElement('div');
          miniStepsWrapper.classList.add('mini-steps-block');
          stepDiv.appendChild(miniStepsWrapper);

          step.miniSteps.forEach((sub, subIndex) => {
            const miniStepContainer = document.createElement('div');
            miniStepContainer.classList.add('mini-step-container');
            miniStepContainer.style.display = 'block';

            const subTitle = document.createElement('div');
            subTitle.classList.add('mini-step-title');
            subTitle.textContent = `Passo ${index + 1}.${subIndex + 1} - ${sub.miniStepTitle}`;
            miniStepContainer.appendChild(subTitle);

            const subDesc = document.createElement('div');
            subDesc.classList.add('mini-step-description');
            subDesc.textContent = sub.miniStepDescription;
            miniStepContainer.appendChild(subDesc);

            if (sub.subStepImage && sub.subStepImage.trim() !== "") {
              const subImgContainer = document.createElement('div');
              subImgContainer.classList.add('mini-step-image-block');
              const subImgEl = document.createElement('img');
              subImgEl.src = `/gridfs_image/${sub.subStepImage}`;
              subImgEl.alt = "Imagem do Subpasso";
              subImgContainer.appendChild(subImgEl);
              miniStepContainer.appendChild(subImgContainer);
            }
            miniStepsWrapper.appendChild(miniStepContainer);
          });
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const solutionContainer = document.getElementById('solutionContainer');
      const stepsData = JSON.parse(solutionContainer.dataset.steps || '[]');
      const stepsOutput = solutionContainer.querySelector('.steps-output');
      const problemID = solutionContainer.dataset.problemId;

      const btnShowSolution = document.getElementById('btnShowSolution');
      const feedbackButtons = document.getElementById('feedbackButtons');
      const btnConsegui = document.getElementById('btnConsegui');
      const btnNaoConsegui = document.getElementById('btnNaoConsegui');
      const failFeedbackForm = document.getElementById('failFeedbackForm');
      const btnEnviarFeedback = document.getElementById('btnEnviarFeedback');
      const failFeedbackText = document.getElementById('failFeedbackText');

      const progressBar = document.getElementById('progressBar');
      const progressInfo = document.getElementById('progressInfo');

      const btnOpenSuggestionModal = document.getElementById('btnOpenSuggestionModal');
      const btnCloseSuggestionModal = document.getElementById('btnCloseSuggestionModal');
      const suggestionModal = document.getElementById('suggestionModal');

      const btnHelpfulSim = document.getElementById('btnHelpfulSim');
      const btnHelpfulNao = document.getElementById('btnHelpfulNao');

      let currentStepIndex = 0;
      let totalSteps = stepsData.length;
      let isSolutionActive = false;

      if (totalSteps > 0) {
        progressInfo.textContent = `0 de ${totalSteps} Passos`;
      } else {
        progressInfo.textContent = "Nenhum passo definido.";
      }

      function updateProgressBar() {
        const percent = (currentStepIndex / totalSteps) * 100;
        progressBar.style.width = `${percent}%`;
        progressInfo.textContent = `${currentStepIndex} de ${totalSteps} Passos`;
      }

      function showCurrentStep() {
        if (currentStepIndex >= totalSteps) {
          progressBar.style.width = "100%";
          progressInfo.textContent = `${totalSteps} de ${totalSteps} Passos (Conclu√≠dos!)`;
          feedbackButtons.style.display = 'none';

          const finishMsg = document.createElement('p');
          finishMsg.style.textAlign = 'center';
          finishMsg.style.fontSize = '1.1rem';
          finishMsg.style.color = '#0a0';
          finishMsg.style.fontWeight = 'bold';
          finishMsg.textContent = "Parab√©ns, voc√™ concluiu todos os passos!";
          stepsOutput.appendChild(finishMsg);
          return;
        }

        const stepDiv = document.createElement('div');
        stepDiv.classList.add('step-container');
        stepsOutput.appendChild(stepDiv);

        revealStepSimple(stepDiv, currentStepIndex + 1, stepsData[currentStepIndex]);

        feedbackButtons.style.display = 'flex';
        failFeedbackForm.style.display = 'none';
        failFeedbackText.value = '';

        updateProgressBar();
      }

      btnConsegui.addEventListener('click', () => {
        const stepContainers = document.querySelectorAll('.step-container');
        if (stepContainers[currentStepIndex]) {
          const checkIcon = document.createElement('div');
          checkIcon.classList.add('step-check-icon');
          checkIcon.textContent = '‚úî';
          stepContainers[currentStepIndex].appendChild(checkIcon);
        }
        feedbackButtons.style.display = 'none';
        currentStepIndex++;
        showCurrentStep();
      });

      btnNaoConsegui.addEventListener('click', () => {
        btnNaoConsegui.classList.add('shake');
        setTimeout(() => {
          btnNaoConsegui.classList.remove('shake');
        }, 500);
        failFeedbackForm.style.display = 'block';
      });

      btnEnviarFeedback.addEventListener('click', () => {
        const feedbackVal = failFeedbackText.value.trim();
        if (!userIsLoggedIn) {
          failFeedbackForm.style.display = 'none';
          feedbackButtons.style.display = 'none';
          currentStepIndex++;
          showCurrentStep();
          return;
        }
        fetch("/submit_step_feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            problem_id: problemID,
            step_index: currentStepIndex,
            success: false,
            feedback_text: feedbackVal
          })
        })
        .then(resp => resp.json())
        .then(data => {
          console.log("Feedback Enviado:", data);
        })
        .catch(err => console.error("Erro ao enviar feedback:", err))
        .finally(() => {
          failFeedbackForm.style.display = 'none';
          feedbackButtons.style.display = 'none';
          currentStepIndex++;
          showCurrentStep();
        });
      });

      if (isSolucionador) {
        // Solucionador v√™ tudo expandido automaticamente
        renderSolutionNoAnimation(stepsOutput, stepsData);
        progressBar.style.width = "100%";
        if (totalSteps > 0) {
          progressInfo.textContent = `${totalSteps} de ${totalSteps} Passos (Modo Solucionador)`;
        } else {
          progressInfo.textContent = "Nenhum passo definido.";
        }
      } else {
        // Usu√°rio comum
        if (totalSteps === 0) {
          return;
        }
        btnShowSolution.style.display = 'inline-block';
        btnShowSolution.addEventListener('click', () => {
          if (isSolutionActive) return;
          isSolutionActive = true;
          btnShowSolution.style.display = 'none';
          showCurrentStep();
        });
      }

      function toggleHelpful(feedbackType) {
        if (!userIsLoggedIn) {
          alert("√â necess√°rio estar logado para registrar o feedback.");
          return;
        }
        fetch("/toggle_helpful", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            problem_id: problemID,
            feedback: feedbackType
          })
        })
        .then(resp => resp.json())
        .then(data => {
          if (data.error) {
            alert(data.error);
            return;
          }
          btnHelpfulSim.classList.remove("selected");
          btnHelpfulNao.classList.remove("selected");
          if (data.feedback === "SIM") {
            btnHelpfulSim.classList.add("selected");
          } else if (data.feedback === "NAO") {
            btnHelpfulNao.classList.add("selected");
          }
        })
        .catch(err => console.error("Erro ao enviar helpful feedback:", err));
      }

      btnHelpfulSim.addEventListener("click", () => toggleHelpful("SIM"));
      btnHelpfulNao.addEventListener("click", () => toggleHelpful("NAO"));

      btnOpenSuggestionModal.addEventListener("click", () => {
        if (!userIsLoggedIn) {
          alert("√â necess√°rio estar logado para enviar sugest√µes.");
          return;
        }
        suggestionModal.style.display = "flex";
      });

      btnCloseSuggestionModal.addEventListener("click", () => {
        suggestionModal.style.display = "none";
      });

      window.addEventListener("click", (event) => {
        if (event.target === suggestionModal) {
          suggestionModal.style.display = "none";
        }
      });
    });

    // Bot√£o "Voltar"
    document.addEventListener('DOMContentLoaded', function() {
      const ref = document.referrer || "";
      const btnVoltar = document.getElementById('btnVoltar');
      if (btnVoltar) {
        btnVoltar.addEventListener('click', function() {
          if (ref.includes('/edit_solution')) {
            window.location.href = "{{ url_for('search') }}";
          }
          else if (!ref) {
            window.location.href = "{{ url_for('search') }}";
          }
          else {
            window.history.back();
          }
        });
      }
    });

    // ============ SCRIPT PARA COMPARTILHAMENTO ============
    document.addEventListener('DOMContentLoaded', function() {
      const openShareModalBtn = document.getElementById('openShareSolutionModalBtn');
      const shareModal = document.getElementById('shareSolutionModal');
      const closeShareModalBtn = document.getElementById('closeShareSolutionModal');
      const btnShareSolutionWhatsApp = document.getElementById('btnShareSolutionWhatsApp');
      const btnShareSolutionFacebook = document.getElementById('btnShareSolutionFacebook');
      const btnShareSolutionInstagram = document.getElementById('btnShareSolutionInstagram');
      const btnCopySolutionLink = document.getElementById('btnCopySolutionLink');
      const btnNativeShareSolution = document.getElementById('btnNativeShareSolution');

      let finalShareURL = "";
      let problemTitle = "";

      if (openShareModalBtn && shareModal && closeShareModalBtn) {
        openShareModalBtn.addEventListener('click', () => {
          finalShareURL = openShareModalBtn.dataset.solutionurl;
          problemTitle = openShareModalBtn.dataset.problemtitle;
          shareModal.style.display = 'flex';
          if (navigator.share) {
            btnNativeShareSolution.style.display = 'block';
          }
        });

        closeShareModalBtn.addEventListener('click', () => {
          shareModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
          if (event.target === shareModal) {
            shareModal.style.display = 'none';
          }
        });
      }

      if (btnNativeShareSolution) {
        btnNativeShareSolution.addEventListener('click', async () => {
          if (!finalShareURL) {
            alert("Link da solu√ß√£o n√£o encontrado.");
            return;
          }
          const shareTitle = `Solu√ß√£o para: ${problemTitle}`;
          const shareText = `Confira esta solu√ß√£o na Plataforma M:\n${finalShareURL}`;
          try {
            await navigator.share({
              title: shareTitle,
              text: shareText,
              url: finalShareURL
            });
          } catch (err) {
            console.log("Usu√°rio cancelou ou erro no compartilhamento nativo:", err);
          }
        });
      }

      if (btnShareSolutionWhatsApp) {
        btnShareSolutionWhatsApp.addEventListener('click', () => {
          if (!finalShareURL) {
            alert("Link da solu√ß√£o n√£o encontrado.");
            return;
          }
          const shareText = `Confira esta solu√ß√£o no M: ${finalShareURL}`;
          const wppLink = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText)}`;
          window.open(wppLink, '_blank');
        });
      }

      if (btnShareSolutionFacebook) {
        btnShareSolutionFacebook.addEventListener('click', () => {
          if (!finalShareURL) {
            alert("Link da solu√ß√£o n√£o encontrado.");
            return;
          }
          const fbLink = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(finalShareURL)}&quote=${encodeURIComponent('Solu√ß√£o do M: ' + problemTitle)}`;
          window.open(fbLink, '_blank');
        });
      }

      if (btnShareSolutionInstagram) {
        btnShareSolutionInstagram.addEventListener('click', () => {
          if (!finalShareURL) {
            alert("Link da solu√ß√£o n√£o encontrado.");
            return;
          }
          alert(
            "No momento, n√£o √© poss√≠vel postar automaticamente no Instagram. " +
            "Voc√™ pode copiar o link e colar no seu Story ou na bio.\n\n" +
            `Link: ${finalShareURL}`
          );
        });
      }

      if (btnCopySolutionLink) {
        btnCopySolutionLink.addEventListener('click', () => {
          if (!finalShareURL) {
            alert("Link da solu√ß√£o n√£o encontrado.");
            return;
          }
          navigator.clipboard
            .writeText(finalShareURL)
            .then(() => {
              alert("Link copiado para a √°rea de transfer√™ncia!");
            })
            .catch((err) => {
              console.error("Erro ao copiar link", err);
              alert("N√£o foi poss√≠vel copiar o link. Tente manualmente.");
            });
        });
      }
    });

    // ============ Adicionar Link de Afiliado (modal) ============
    {% if session.get("role") == "solucionador" %}
    document.addEventListener('DOMContentLoaded', function() {
      const addAffiliateLinkModal = document.getElementById('addAffiliateLinkModal');
      const openAddAffiliateLinkModalBtn = document.getElementById('btnOpenAddAffiliateLinkModal');
      const closeAddAffiliateLinkModalBtn = document.getElementById('closeAddAffiliateLinkModal');

      if (openAddAffiliateLinkModalBtn && addAffiliateLinkModal) {
        openAddAffiliateLinkModalBtn.addEventListener('click', () => {
          addAffiliateLinkModal.style.display = 'flex';
        });
      }
      if (closeAddAffiliateLinkModalBtn) {
        closeAddAffiliateLinkModalBtn.addEventListener('click', () => {
          addAffiliateLinkModal.style.display = 'none';
        });
      }
      window.addEventListener("click", (event) => {
        if (event.target === addAffiliateLinkModal) {
          addAffiliateLinkModal.style.display = "none";
        }
      });
    });
    {% endif %}
  </script>
</body>
</html>
