<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Editar Solução</title>
  <!-- Responsividade em dispositivos móveis -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonte básica (opcional) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap"
    rel="stylesheet"
  />

  <style>
    /* =========================================================================
       RESET BÁSICO
       ========================================================================= */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* =========================================================================
       BODY / FONTES / CORES GERAIS
       ========================================================================= */
    body {
      font-family: 'Roboto', sans-serif;
      font-size: 1rem;
      background-color: #f0f0f0;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* =========================================================================
       HEADER PRETO COM BOTÃO DE VOLTAR (MESMO PADRÃO DO item_search.html)
       ========================================================================= */
    header {
      background-color: #000;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between; /* Espaçar: voltar, título, espaço vago */
      position: relative;
    }
    /* Botão "Voltar" (borda arredondada, seta grande 2rem) */
    .btn-voltar-inicio {
      background-color: #000;
      color: #fff;
      border: none;
      border-radius: 32px; /* Arredondado */
      padding: 0.7rem 1.2rem;
      font-size: 2rem; /* ÍCONE (SETA) MAIOR */
      cursor: pointer;
      text-decoration: none;
      font-weight: 500;
      transition: background-color 0.2s, transform 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-voltar-inicio:hover {
      background-color: #333;
      transform: scale(1.02);
    }
    header h1 {
      color: #fff;
      font-size: 1.4rem;
      text-align: center;
      margin: 0 auto;
    }

    /* =========================================================================
       MAIN
       ========================================================================= */
    main {
      flex: 1;
      font-size: 1rem;
      padding: 2rem 1rem;
      width: 100%;
      max-width: 1200px; /* Padrão de largura do container em item_search.html */
      margin: 0 auto;
      display: flex;
      flex-direction: column;
    }

    /* Título do problema (centrado) */
    .problem-title {
      text-align: center;
      font-size: 1.4rem;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .erro {
      color: #d00;
      margin-bottom: 1rem;
      font-weight: bold;
    }

    .info {
      margin-bottom: 1rem;
      color: #555;
    }

    /* Container principal do formulário */
    .form-container {
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Botões */
    .btn {
      display: inline-block;
      padding: 0.6rem 1.2rem;
      border: none;
      background-color: #000;
      color: #fff;
      font-weight: 500;
      cursor: pointer;
      border-radius: 32px; /* Arredondado */
      margin: 0.5rem 0;
      transition: background-color 0.2s, transform 0.2s;
    }
    .btn:hover {
      background-color: #333;
      transform: scale(1.02);
    }

    .btn-remove {
      background-color: #f44336;
      margin-left: 1rem;
    }
    .btn-remove:hover {
      background-color: #d32f2f;
    }

    /* Passo */
    .step-block {
      background-color: #f9f9f9;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .step-block h2 {
      margin-top: 0;
      font-size: 1.1rem;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-bottom: 0.3rem;
      font-weight: 500;
      color: #555;
    }
    input[type="text"],
    textarea {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #fff;
      color: #333;
      font-size: 1rem;
      outline: none;
    }
    input[type="text"]:focus,
    textarea:focus {
      border-color: #aaa;
    }

    /* Subpassos */
    .subpasso-container {
      background-color: #fff;
      padding: 0.8rem;
      margin-top: 0.5rem;
      border-radius: 4px;
      border: 1px solid #eee;
    }
    .subpasso-block {
      border: 1px dashed #ccc;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
      background-color: #fafafa;
    }
    .subpasso-block h3 {
      margin-top: 0;
      color: #444;
      font-size: 1rem;
      margin-bottom: 0.3rem;
    }

    /* Botão de salvar */
    .btn-save {
      background-color: #4caf50;
    }
    .btn-save:hover {
      background-color: #45a049;
    }
    /* Botão de cancelar */
    .btn-cancel {
      background-color: #999;
      color: #fff;
      margin-left: 1rem;
    }
    .btn-cancel:hover {
      background-color: #666;
    }

    /* Rodapé */
    footer {
      background-color: #000;
      text-align: center;
      padding: 1rem 2rem;
    }
    footer p {
      font-size: 0.9rem;
      color: #fff;
      margin: 0;
    }

    /* Preview da nova imagem */
    .new-file-preview img {
      max-width: 200px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      display: block;
    }

    /* =========================================================================
       MEDIA QUERIES (VERSÃO MOBILE)
       ========================================================================= */
    @media (max-width: 768px) {
      header {
        padding: 1rem;
      }
      header h1 {
        font-size: 1.2rem;
      }
      .btn-voltar-inicio {
        padding: 0.5rem 1rem;
        /* Mantemos font-size 2rem para a seta grande também no mobile */
      }
      main {
        padding: 1rem;
      }
      .problem-title {
        font-size: 1.2rem;
        margin-bottom: 0.8rem;
      }
      .form-container {
        padding: 1rem;
      }
      .step-block {
        padding: 0.8rem;
      }
      .step-block h2 {
        font-size: 1rem;
      }
      label {
        font-size: 0.9rem;
      }
      input[type="text"],
      textarea {
        font-size: 0.9rem;
        padding: 0.5rem;
      }
      .btn {
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
      }
      .btn-save, .btn-cancel {
        font-size: 0.8rem;
      }
      .info {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <!-- Cabeçalho com botão de voltar e título (mesmo padrão de item_search.html) -->
  <header>
    <a
      href="{{ url_for('exibir_solucao', problem_id=problema['_id']) }}"
      class="btn-voltar-inicio"
      title="Voltar"
    >
      &#x2B05;
    </a>
    <h1>Editar Solução</h1>
    <!-- Espaço vazio à direita para manter alinhamento -->
    <div style="width: 2rem;"></div>
  </header>

  <main>
    <h2 class="problem-title">{{ problema["titulo"] }}</h2>

    {% if erro %}
      <div class="erro">{{ erro }}</div>
    {% endif %}

    <p class="info">
      Ajuste os passos e subpassos conforme necessário. Clique em <strong>Salvar Alterações</strong> ao final.
      <br>Você também pode enviar uma nova imagem para cada passo/subpasso, além de remover uma imagem existente.
      <br>Ao selecionar um arquivo, verá uma pré-visualização abaixo.
    </p>

    <div class="form-container">
      <!-- Importante: multipart/form-data para upload de imagens -->
      <form method="POST" id="solutionForm" enctype="multipart/form-data">
        <input type="hidden" id="solution_data" name="solution_data" value="" />

        <div id="stepsContainer">
          {% for step in passos %}
            {% set stepIndex = loop.index0 %}
            <div class="step-block" data-step-index="{{ stepIndex }}">
              <h2>Passo {{ stepIndex + 1 }}</h2>

              <div class="form-group">
                <label>Título do Passo:</label>
                <input type="text" class="step-title" value="{{ step.stepTitle|default('') }}">
              </div>

              <div class="form-group">
                <label>Descrição do Passo:</label>
                <textarea class="step-desc">{{ step.stepDescription|default('') }}</textarea>
              </div>

              <!-- Imagem do Passo -->
              <div class="form-group">
                <label>Imagem do Passo (opcional):</label>
                <input
                  type="file"
                  name="stepImage_{{ stepIndex }}"
                  accept="image/*"
                  class="file-input"
                >
                <!-- Container de pré-visualização (nova imagem) -->
                <div class="new-file-preview"></div>

                {% if step.stepImage %}
                  <div style="margin-top: 8px; border: 1px solid #eee; padding: 8px;">
                    <p style="margin-bottom: 4px;">Imagem atual:</p>
                    <img
                      src="{{ url_for('gridfs_image', file_id=step.stepImage) }}"
                      alt="Imagem do Passo"
                      style="max-width: 200px; display: block; margin-bottom: 8px;"
                    >
                    <!-- Botão para deletar a imagem existente -->
                    <button
                      type="button"
                      class="btn btn-remove delete-image-btn"
                      data-target="StepImage_{{ stepIndex }}"
                    >
                      Deletar Imagem
                    </button>
                    <!-- Campo hidden para identificar se o usuário deseja remover essa imagem -->
                    <input
                      type="hidden"
                      name="deleteExistingStepImage_{{ stepIndex }}"
                      value="false"
                    >
                  </div>
                {% endif %}
              </div>

              <!-- SUBPASSOS -->
              <div class="subpasso-container">
                <h3>Subpassos</h3>
                <div class="subpasso-list">
                  {% for sub in step.miniSteps %}
                    {% set subIndex = loop.index0 %}
                    <div class="subpasso-block" data-sub-index="{{ subIndex }}">
                      <h3>Subpasso {{ subIndex + 1 }}</h3>
                      <div class="form-group">
                        <label>Título:</label>
                        <input
                          type="text"
                          class="subpasso-title"
                          value="{{ sub.miniStepTitle|default('') }}"
                        >
                      </div>
                      <div class="form-group">
                        <label>Descrição:</label>
                        <textarea class="subpasso-desc">{{ sub.miniStepDescription|default('') }}</textarea>
                      </div>
                      <div class="form-group">
                        <label>Imagem do Subpasso (opcional):</label>
                        <input
                          type="file"
                          name="subStepImage_{{ stepIndex }}_{{ subIndex }}"
                          accept="image/*"
                          class="file-input"
                        >
                        <!-- Container de pré-visualização (nova imagem) -->
                        <div class="new-file-preview"></div>

                        {% if sub.subStepImage %}
                          <div style="margin-top: 8px; border: 1px solid #eee; padding: 8px;">
                            <p style="margin-bottom: 4px;">Imagem atual:</p>
                            <img
                              src="{{ url_for('gridfs_image', file_id=sub.subStepImage) }}"
                              alt="Imagem do Subpasso"
                              style="max-width: 200px; display: block; margin-bottom: 8px;"
                            >
                            <!-- Botão para deletar a imagem existente -->
                            <button
                              type="button"
                              class="btn btn-remove delete-image-btn"
                              data-target="SubStepImage_{{ stepIndex }}_{{ subIndex }}"
                            >
                              Deletar Imagem
                            </button>
                            <!-- Hidden para excluir imagem existente -->
                            <input
                              type="hidden"
                              name="deleteExistingSubStepImage_{{ stepIndex }}_{{ subIndex }}"
                              value="false"
                            >
                          </div>
                        {% endif %}
                      </div>
                      <button type="button" class="btn btn-remove remove-subpasso">
                        Remover Subpasso
                      </button>
                    </div>
                  {% endfor %}
                </div>
                <button type="button" class="btn add-subpasso">Adicionar Subpasso</button>
              </div>

              <button type="button" class="btn btn-remove remove-step">Remover Passo</button>
            </div>
          {% endfor %}
        </div>

        <button type="button" class="btn" id="addStepBtn" style="margin-top: 1rem;">
          Adicionar Passo
        </button>

        <br><br>
        <button type="submit" class="btn btn-save" style="margin-right: 1rem;">
          Salvar Alterações
        </button>
        <a
          href="{{ url_for('exibir_solucao', problem_id=problema['_id']) }}"
          class="btn btn-cancel"
        >
          Cancelar
        </a>
      </form>
    </div>
  </main>

  <footer>
    <p>© 2025 Plataforma M - MVP</p>
  </footer>

  <script>
    const stepsContainer = document.getElementById('stepsContainer');
    const solutionDataInput = document.getElementById('solution_data');
    const form = document.getElementById('solutionForm');
    const addStepBtn = document.getElementById('addStepBtn');

    // Cria dinamicamente um passo
    function createStepBlock(stepIndex) {
      const stepBlock = document.createElement('div');
      stepBlock.classList.add('step-block');
      stepBlock.setAttribute('data-step-index', stepIndex);

      stepBlock.innerHTML = `
        <h2>Passo ${stepIndex + 1}</h2>
        <div class="form-group">
          <label>Título do Passo:</label>
          <input type="text" class="step-title" placeholder="Ex: Identificar problema">
        </div>
        <div class="form-group">
          <label>Descrição do Passo:</label>
          <textarea class="step-desc" placeholder="Ex: Verificar o local com barulho"></textarea>
        </div>
        <div class="form-group">
          <label>Imagem do Passo (opcional):</label>
          <input type="file" name="stepImage_${stepIndex}" accept="image/*" class="file-input">
          <div class="new-file-preview"></div>
        </div>
        <div class="subpasso-container">
          <h3>Subpassos</h3>
          <div class="subpasso-list"></div>
          <button type="button" class="btn add-subpasso">Adicionar Subpasso</button>
        </div>
        <button type="button" class="btn btn-remove remove-step">Remover Passo</button>
      `;
      return stepBlock;
    }

    // Cria dinamicamente um subpasso
    function createSubpassoBlock(stepIndex, subIndex) {
      const subBlock = document.createElement('div');
      subBlock.classList.add('subpasso-block');
      subBlock.setAttribute('data-sub-index', subIndex);

      subBlock.innerHTML = `
        <h3>Subpasso ${subIndex + 1}</h3>
        <div class="form-group">
          <label>Título:</label>
          <input type="text" class="subpasso-title" placeholder="Ex: Abrir tampa">
        </div>
        <div class="form-group">
          <label>Descrição:</label>
          <textarea class="subpasso-desc" placeholder="Ex: Visualizar o interior"></textarea>
        </div>
        <div class="form-group">
          <label>Imagem do Subpasso (opcional):</label>
          <input type="file" name="subStepImage_${stepIndex}_${subIndex}" accept="image/*" class="file-input">
          <div class="new-file-preview"></div>
        </div>
        <button type="button" class="btn btn-remove remove-subpasso">Remover Subpasso</button>
      `;
      return subBlock;
    }

    // Botão "Adicionar Passo"
    addStepBtn.addEventListener('click', () => {
      const stepIndex = stepsContainer.children.length;
      const stepBlock = createStepBlock(stepIndex);
      stepsContainer.appendChild(stepBlock);
    });

    // Delegação de eventos para remover passos/subpassos e adicionar subpassos
    stepsContainer.addEventListener('click', (e) => {
      // Remover Passo
      if (e.target.classList.contains('remove-step')) {
        const stepBlock = e.target.closest('.step-block');
        if (stepBlock) {
          stepsContainer.removeChild(stepBlock);
          reindexSteps();
        }
      }

      // Adicionar Subpasso
      if (e.target.classList.contains('add-subpasso')) {
        const stepBlock = e.target.closest('.step-block');
        const stepIndex = parseInt(stepBlock.getAttribute('data-step-index'));
        const subpassoList = stepBlock.querySelector('.subpasso-list');
        const subIndex = subpassoList.children.length;
        const subBlock = createSubpassoBlock(stepIndex, subIndex);
        subpassoList.appendChild(subBlock);
      }

      // Remover Subpasso
      if (e.target.classList.contains('remove-subpasso')) {
        const subBlock = e.target.closest('.subpasso-block');
        const stepBlock = e.target.closest('.step-block');
        if (subBlock && stepBlock) {
          const subpassoList = stepBlock.querySelector('.subpasso-list');
          subpassoList.removeChild(subBlock);
          reindexSubpassos(subpassoList, parseInt(stepBlock.getAttribute('data-step-index')));
        }
      }
    });

    // Reindexa passos
    function reindexSteps() {
      const stepBlocks = stepsContainer.querySelectorAll('.step-block');
      stepBlocks.forEach((block, index) => {
        block.setAttribute('data-step-index', index);
        const h2 = block.querySelector('h2');
        if (h2) {
          h2.textContent = `Passo ${index + 1}`;
        }
        // Atualiza name do input file do passo
        const stepFileInput = block.querySelector(`input[type="file"][name^="stepImage_"]`);
        if (stepFileInput) {
          stepFileInput.name = `stepImage_${index}`;
        }
        // Subpassos
        const subpassoList = block.querySelector('.subpasso-list');
        reindexSubpassos(subpassoList, index);
      });
    }

    // Reindexa subpassos
    function reindexSubpassos(subpassoList, stepIndex) {
      if (!subpassoList) return;
      const subBlocks = subpassoList.querySelectorAll('.subpasso-block');
      subBlocks.forEach((block, index) => {
        block.setAttribute('data-sub-index', index);
        const h3 = block.querySelector('h3');
        if (h3) {
          h3.textContent = `Subpasso ${index + 1}`;
        }
        // Atualiza nome do input file
        const fileInput = block.querySelector(`input[type="file"][name^="subStepImage_"]`);
        if (fileInput) {
          fileInput.name = `subStepImage_${stepIndex}_${index}`;
        }
      });
    }

    // Antes de submeter o formulário, criamos o JSON com todos os dados (exceto as imagens)
    form.addEventListener('submit', () => {
      const allSteps = [];
      const stepBlocks = stepsContainer.querySelectorAll('.step-block');

      stepBlocks.forEach((stepBlock) => {
        const tituloStep = stepBlock.querySelector('.step-title').value.trim();
        const descStep = stepBlock.querySelector('.step-desc').value.trim();

        // Subpassos
        const subpassoList = stepBlock.querySelector('.subpasso-list');
        const subBlocks = subpassoList.querySelectorAll('.subpasso-block');
        const subPassosData = [];

        subBlocks.forEach((subBlock) => {
          const tituloSub = subBlock.querySelector('.subpasso-title').value.trim();
          const descSub = subBlock.querySelector('.subpasso-desc').value.trim();

          subPassosData.push({
            miniStepTitle: tituloSub,
            miniStepDescription: descSub
            // subStepImage será tratado no back-end
          });
        });

        allSteps.push({
          stepTitle: tituloStep,
          stepDescription: descStep,
          miniSteps: subPassosData
          // stepImage também tratado no back-end
        });
      });

      const finalSolution = {
        steps: allSteps
      };
      solutionDataInput.value = JSON.stringify(finalSolution);
    });

    // Pré-visualização imediata ao selecionar uma nova imagem
    document.addEventListener('change', function(e) {
      if (e.target && e.target.classList.contains('file-input')) {
        const file = e.target.files[0];
        const previewDiv = e.target.parentNode.querySelector('.new-file-preview');
        if (!previewDiv) return;
        if (file) {
          const reader = new FileReader();
          reader.onload = function(evt) {
            previewDiv.innerHTML = `<img src="${evt.target.result}" alt="Pré-visualização">`;
          };
          reader.readAsDataURL(file);
        } else {
          // Se o usuário removeu o arquivo
          previewDiv.innerHTML = '';
        }
      }
    });

    // Botão de deletar imagem existente (marca o hidden para "true")
    document.addEventListener('click', function(e) {
      if (e.target && e.target.classList.contains('delete-image-btn')) {
        e.preventDefault();
        const targetAttr = e.target.dataset.target;
        // targetAttr pode ser "StepImage_i" ou "SubStepImage_i_j"
        // Mapeamos isso para o input hidden "deleteExistingStepImage_i" ou "deleteExistingSubStepImage_i_j"
        let prefix = "";
        let stepIndex = null;
        let subIndex = null;

        if (targetAttr.startsWith("StepImage_")) {
          prefix = "deleteExistingStepImage_";
          stepIndex = targetAttr.split("_")[1];
        } else if (targetAttr.startsWith("SubStepImage_")) {
          prefix = "deleteExistingSubStepImage_";
          const parts = targetAttr.split("_");
          stepIndex = parts[1];
          subIndex = parts[2];
        }

        let hiddenInputName = prefix + stepIndex;
        if (subIndex !== null) {
          hiddenInputName += `_${subIndex}`;
        }

        // Seleciona o input hidden e define como true
        const hiddenInput = document.querySelector(`input[name="${hiddenInputName}"]`);
        if (hiddenInput) {
          hiddenInput.value = "true";
        }

        // Remove a visualização da imagem atual do DOM
        const parentContainer = e.target.closest('div');
        if (parentContainer) {
          parentContainer.innerHTML = '<p style="color:red;">Imagem marcada para exclusão.</p>';
        }
      }
    });
  </script>
</body>
</html>
